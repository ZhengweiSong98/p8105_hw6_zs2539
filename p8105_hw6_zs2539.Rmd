---
title: "HW6 Solution"
author: "Zhengwei Song"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(p8105.datasets)
library(viridis)
library(rstatix)
library(PerformanceAnalytics)
library(modelr)
knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

## Problem 2

## Importing the dataset
```{r, warning = FALSE, message=FALSE}
homicide_raw <- read_csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv")
```

#### Creating a `city_state` variable, binary variable `resolution` indicating case disposition, omitting cities excluded victim race and Tulsa, AL with data entry mistake. Also, limiting `victim_race` is white or black, making `victim_age` numeric.
```{r, warning = FALSE, message=FALSE}
homicide_df = homicide_raw %>% 
    janitor::clean_names() %>%
    mutate(
        reported_date = as.Date(as.character(reported_date), format = "%Y%m%d"),
        city_state = str_c(city, state, sep = ", "),
        resolved = as.numeric(disposition == "Closed by arrest"),
        victim_age = as.numeric(victim_age),
        victim_race = fct_relevel(victim_race, "White")
    ) %>%
    relocate(city_state) %>%
    filter(city_state != c("Tulsa, AL","Dallas, TX","Phoenix, AZ","Kansas City, MO"),
           victim_race == c("White","Black"))
```

#### Applying `glm` to fit a logistic regression with resolved vs unresolved as the outcome; victim age, sex and race as predictors. Also, saving the output of `glm` as an R object.
```{r, warning = FALSE, message=FALSE}
baltimore_logistic = homicide_df %>%
    filter(city_state == "Baltimore, MD") %>%
    glm(resolved ~ victim_age + victim_race + victim_sex, data = ., family = binomial()) 
```

#### Applying the `broom::tidy` to the above object; Obtaining the estimate and confidence interval of the adjusted odds ratio, for solving homicides comparing male victims to female victims keeping all other variables fixed.
```{r, warning = FALSE, message=FALSE}
baltimore_logistic %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),
         ci_lower = quantile(OR, 0.025),
        ci_upper = quantile(OR, 0.975)) %>%
  select(term, log_OR = estimate, OR,ci_lower,ci_upper, p.value) %>% 
  knitr::kable(digits = 3)
```
* Keeping all other variables fixed, in Baltimore, MD, homicides in which the victim is male are significantly less like to be resolved than those in which the victim is female.

## Running `glm` for each of the cities in the dataset; Extracting the adjusted odds ratio and CI, for solving homicides comparing male victims to female victims; 
```{r, warning = FALSE, message=FALSE}
allcities_logistic = homicide_df %>% 
  nest(data = -city_state) %>% 
  mutate(
    models = map(data, ~glm(resolved ~ victim_age + victim_race + victim_sex, data = ., family = binomial())),
    results = map(models, broom::tidy)) %>% 
  select(-data, -models) %>% 
  unnest(results)
```

```{r, warning = FALSE, message=FALSE}
allcities_logistic %>%
  mutate(term = fct_inorder(term),
         OR = exp(estimate),
         ci_lower = quantile(OR, 0.025),
        ci_upper = quantile(OR, 0.975)) %>%
    select(city_state, term, log_OR = estimate, OR, ci_lower,ci_upper,p.value) %>% 
  knitr::kable(digits = 3)
```
* Keeping all other variables fixed, in XXX,XXX,XXX, homicides in which the victim is male are significantly less like to be resolved than those in which the victim is female.

```{r, warning = FALSE, message=FALSE}
allcities_logistic %>% 
  filter(str_detect(term, "victim_sex")) %>% 
  ggplot(aes(x = city_state, y = exp(estimate))) + 
  geom_point() + 
  facet_wrap(~term) + 
  theme(axis.text.x = element_text(angle = 80, hjust = 1))
```

## Problem 3

#### Loading and cleaning the data
```{r, warning = FALSE, message=FALSE}
birthweight_raw = read_csv("./data/birthweight.csv")

birthweight_df = birthweight_raw %>% 
    janitor::clean_names() %>%
    mutate(across(.cols = c(babysex, frace, malform, mrace), as.factor)) %>%
  mutate(babysex = ifelse(babysex == "1", "male","female"),
         malform = ifelse(malform == "0", "absent","present"),
         frace = recode(frace, "1" = "White", "2" = "Black", "3" = "Asian", 
                        "4" = "Puerto Rican", "8" = "Other", "9" = "Unknown"),
         mrace = recode(mrace, "1" = "White", "2" = "Black", 
                        "3" = "Asian", "4" = "Puerto Rican", "8" = "Other")
         )
```
* `babysex`,`frace`,`malform` and `mrace` were converted from numeric to factor, because they are categorical variables.

* These categorical data are `recode` to make it more intuitive.

```{r, warning = FALSE, message=FALSE}
skimr::skim(birthweight_df)
```
* There is no missing data. The cleaned dataset contains `r nrow(birthweight_df)` observations and `r ncol(birthweight_df)` variables: `r names(birthweight_df)`

#### The Correlations with Birth Weight
```{r, warning = FALSE, message=FALSE}
birthweight_raw %>% 
  cor_mat() %>%
  cor_gather() %>%
  filter(var1 %in% "bwt") %>%
  filter(!var2 %in% "bwt") %>%
  mutate(
    sig_p = ifelse(p < 0.01, T, F),
    cor_if_sig = ifelse(p < 0.01, cor, NA)
    ) %>% 
  ggplot(aes(
    x = var1, 
    y = var2, 
    fill = cor,
    label = round(cor_if_sig, 2))) + 
  geom_tile(color = "white") +   
  geom_text(
    color = "white",
    size = 4
  ) + 
  scale_x_discrete(
    labels = c("Birth Weight")
  ) + 
  labs(
    x = "Outcome",
    y = "Predictors",
    title = "Correlations between predictors and outcome",
    subtitle = "significant predictors at significance level 0.01",
    fill = "Correlation"
  )
```
* Based on t-test, the variables with p-value less than 0.01 are to be selected as predictors. To simple, the continuous are to be selected.

#### Fitting the linear model
```{r, warning = FALSE, message=FALSE}
continuous_variables =  
  birthweight_df %>%
  select_if(is.numeric) %>%
  select(-bwt, -ppbmi, -ppwt, -pnumsga, -parity, -pnumlbw) %>%
  colnames() %>% 
  as.list()

for (i in continuous_variables) {
  plot =
  ggplot(birthweight_df, aes_string(i,  "bwt")) + 
  geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  labs(title = "Scatterplot", y = "Birth Weight") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
  
  print(plot)
}
```

```{r, warning = FALSE, message=FALSE}
selected_variables =
  birthweight_df %>%
  select(bhead, blength, delwt, gaweeks, wtgain, bwt)
chart.Correlation(selected_variables, method = "pearson")
```

```{r, warning = FALSE, message=FALSE}
selected_variables =
  birthweight_df %>%
  select(bhead, blength, gaweeks, bwt, babysex, mrace)
```

```{r, warning = FALSE, message=FALSE}
fit_final <- lm(bwt ~ bhead + blength + gaweeks + babysex + mrace + bhead:blength +
             bhead:blength:gaweeks, 
           data = selected_variables)
summary(fit_final) %>% 
  broom::tidy() %>%
  select(term, estimate, p.value)
summary(fit_final) %>% 
  broom::glance()
```

```{r, warning = FALSE, message=FALSE}
selected_variables %>%
  add_residuals(fit_final) %>%
  add_predictions(fit_final) %>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Plot of the model residuals against fitted values",
       x = "Fitted Values", y = "Residuals") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

#### Cross Validation
```{r, warning = FALSE, message=FALSE}
set.seed(77)
cv_dataset <-
  selected_variables %>% 
  crossv_mc(n = 100,test = 0.2)
  
cv_df <- 
  cv_dataset %>%
   mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))
cv_df <-
  cv_df %>%
    mutate(
    linear_mod1  = map(train, ~lm(bwt ~ bhead + blength + gaweeks + babysex + mrace 
                                  + bhead:blength + bhead:blength:gaweeks, 
                                  data = .x)),
    linear_mod2  = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
    linear_mod3  = map(train, ~lm(bwt ~ (bhead + blength + babysex)^3, data = .x))
    ) %>%
   mutate(
    rmse_my_model = map2_dbl(linear_mod1, test, ~rmse(model = .x, data = .y)),
    rmse_given_model1 = map2_dbl(linear_mod2, test, ~rmse(model = .x, data = .y)),
    rmse_given_model2 = map2_dbl(linear_mod3, test, ~rmse(model = .x, data = .y))
   )
```

```{r, warning = FALSE, message=FALSE}
cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + 
  geom_boxplot() +
  labs(title = 
  "Prediction Error Distributions across Models", 
       x = "Models", y = "Root Mean Square Error")  +
  scale_x_discrete(
    labels = c("My Model", "Test Model 1", "Test Model 2")) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```
